{"version":3,"file":"fileSystemPersist.js","sourceRoot":"","sources":["../../../../../src/platform/nodejs/persist/fileSystemPersist.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation.\n// Licensed under the MIT License.\n\nimport { tmpdir, userInfo } from \"node:os\";\nimport { basename, join, dirname } from \"node:path\";\nimport { createHash } from \"node:crypto\";\nimport { diag } from \"@opentelemetry/api\";\nimport type { PersistentStorage } from \"../../../types.js\";\nimport { FileAccessControl } from \"./fileAccessControl.js\";\nimport { confirmDirExists, getShallowDirectorySize } from \"./fileSystemHelpers.js\";\nimport type { AzureMonitorExporterOptions } from \"../../../config.js\";\nimport { readdir, readFile, stat, unlink, writeFile } from \"node:fs/promises\";\nimport type { CustomerSDKStatsMetrics } from \"../../../export/statsbeat/customerSDKStats.js\";\nimport { DropCode, ExceptionType } from \"../../../export/statsbeat/types.js\";\nimport type { TelemetryItem as Envelope } from \"../../../generated/index.js\";\n\n/**\n * File system persist class.\n * @internal\n */\nexport class FileSystemPersist implements PersistentStorage {\n  static TEMPDIR_PREFIX = \"opentelemetry-nodejs-\";\n  static FILENAME_SUFFIX = \".ai.json\";\n\n  fileRetemptionPeriod = 2 * 24 * 60 * 60 * 1000; // 2 days\n  cleanupTimeOut = 60 * 60 * 1000; // 1 hour\n  maxBytesOnDisk: number = 50_000_000; // ~50MB\n\n  private _enabled: boolean;\n  private _tempDirectory: string = \"\";\n  private _fileCleanupTimer: NodeJS.Timeout | null = null;\n  private _instrumentationKey: string;\n\n  constructor(\n    instrumentationKey: string,\n    private _options?: AzureMonitorExporterOptions,\n    private _customerSDKStatsMetrics?: CustomerSDKStatsMetrics,\n  ) {\n    this._instrumentationKey = instrumentationKey;\n    if (this._options?.disableOfflineStorage) {\n      this._enabled = false;\n      return;\n    }\n    this._enabled = true;\n    FileAccessControl.checkFileProtection();\n\n    if (!FileAccessControl.OS_PROVIDES_FILE_PROTECTION) {\n      this._enabled = false;\n      diag.error(\n        \"Sufficient file protection capabilities were not detected. Files will not be persisted\",\n      );\n    }\n\n    if (!this._instrumentationKey) {\n      this._enabled = false;\n      diag.error(\n        `No instrumentation key was provided to FileSystemPersister. Files will not be persisted`,\n      );\n    }\n    if (this._enabled) {\n      this._tempDirectory = getStorageDirectory(\n        this._instrumentationKey,\n        this._options?.storageDirectory,\n      );\n\n      // Starts file cleanup task\n      if (!this._fileCleanupTimer) {\n        this._fileCleanupTimer = setTimeout(() => {\n          this._fileCleanupTask();\n        }, this.cleanupTimeOut);\n        this._fileCleanupTimer.unref();\n      }\n    }\n  }\n\n  push(value: unknown[]): Promise<boolean> {\n    if (this._enabled) {\n      diag.debug(\"Pushing value to persistent storage\", value.toString());\n      return this._storeToDisk(JSON.stringify(value), value as Envelope[]);\n    }\n    // Only return a false promise if the SDK isn't set to disable offline storage\n    if (!this._options?.disableOfflineStorage) {\n      return new Promise((resolve) => {\n        resolve(false);\n      });\n    }\n    return new Promise((resolve) => {\n      resolve(true);\n    });\n  }\n\n  async shift(): Promise<unknown> {\n    if (this._enabled) {\n      diag.debug(\"Searching for filesystem persisted files\");\n      try {\n        const buffer = await this._getFirstFileOnDisk();\n        if (buffer) {\n          return JSON.parse(buffer.toString(\"utf8\"));\n        }\n      } catch (e: any) {\n        diag.debug(\"Failed to read persisted file\", e);\n      }\n      return null;\n    }\n    return new Promise((resolve) => {\n      resolve(null);\n    });\n  }\n\n  /**\n   * Check for temp telemetry files\n   * reads the first file if exist, deletes it and tries to send its load\n   */\n  private async _getFirstFileOnDisk(): Promise<Buffer | null> {\n    try {\n      const stats = await stat(this._tempDirectory);\n      if (stats.isDirectory()) {\n        const origFiles = await readdir(this._tempDirectory);\n        const files = origFiles.filter((f) =>\n          basename(f).includes(FileSystemPersist.FILENAME_SUFFIX),\n        );\n        if (files.length === 0) {\n          return null;\n        } else {\n          const firstFile = files[0];\n          const filePath = join(this._tempDirectory, firstFile);\n          const payload = await readFile(filePath);\n          // delete the file first to prevent double sending\n          await unlink(filePath);\n          return payload;\n        }\n      }\n      return null;\n    } catch (e: any) {\n      if (e.code === \"ENOENT\") {\n        // File does not exist -- return null instead of throwing\n        return null;\n      } else {\n        throw e;\n      }\n    }\n  }\n\n  /**\n   * Stores telemetry data to disk.\n   * @param payload - The telemetry data to store.\n   * @param envelopeLength -The length of the telemetry envelope.\n   * @returns A promise that resolves to true if the data was stored successfully, false otherwise.\n   */\n  private async _storeToDisk(payload: string, envelopes: Envelope[]): Promise<boolean> {\n    try {\n      await confirmDirExists(this._tempDirectory);\n    } catch (error: any) {\n      // Check if error is due to permission/readonly issues\n      if (error?.code === \"EACCES\" || error?.code === \"EPERM\") {\n        this._customerSDKStatsMetrics?.countDroppedItems(envelopes, DropCode.CLIENT_READONLY);\n        diag.warn(\n          `Permission denied while checking/creating directory: ${this._tempDirectory}`,\n          error?.message,\n        );\n      } else {\n        diag.warn(`Error while checking/creating directory: `, error && error.message);\n      }\n      return false;\n    }\n\n    try {\n      const size = await getShallowDirectorySize(this._tempDirectory);\n      if (size > this.maxBytesOnDisk) {\n        // If the directory size exceeds the max limit, we send customer SDK Stats and warn the user\n        this._customerSDKStatsMetrics?.countDroppedItems(\n          envelopes,\n          DropCode.CLIENT_PERSISTENCE_CAPACITY,\n        );\n        diag.warn(\n          `Not saving data due to max size limit being met. Directory size in bytes is: ${size}`,\n        );\n        return false;\n      }\n    } catch (error: any) {\n      diag.warn(`Error while checking size of persistence directory: `, error && error.message);\n      return false;\n    }\n\n    const fileName = `${new Date().getTime()}${FileSystemPersist.FILENAME_SUFFIX}`;\n    const fileFullPath = join(this._tempDirectory, fileName);\n\n    // Mode 600 is w/r for creator and no read access for others\n    diag.info(`saving data to disk at: ${fileFullPath}`);\n    try {\n      await writeFile(fileFullPath, payload, { mode: 0o600 });\n    } catch (writeError: any) {\n      // If the envelopes cannot be written to disk, we send customer SDK Stats and warn the user\n      this._customerSDKStatsMetrics?.countDroppedItems(\n        envelopes,\n        DropCode.CLIENT_EXCEPTION,\n        writeError?.message,\n        ExceptionType.STORAGE_EXCEPTION,\n      );\n      diag.warn(`Error writing file to persistent file storage`, writeError);\n      return false;\n    }\n    return true;\n  }\n\n  private async _fileCleanupTask(): Promise<boolean> {\n    try {\n      const stats = await stat(this._tempDirectory);\n      if (stats.isDirectory()) {\n        const origFiles = await readdir(this._tempDirectory);\n        const files = origFiles.filter((f) =>\n          basename(f).includes(FileSystemPersist.FILENAME_SUFFIX),\n        );\n        if (files.length === 0) {\n          return false;\n        } else {\n          files.forEach(async (file) => {\n            // Check expiration\n            const fileCreationDate: Date = new Date(\n              parseInt(file.split(FileSystemPersist.FILENAME_SUFFIX)[0]),\n            );\n            const expired = new Date(+new Date() - this.fileRetemptionPeriod) > fileCreationDate;\n            if (expired) {\n              const filePath = join(this._tempDirectory, file);\n              await unlink(filePath);\n            }\n          });\n          return true;\n        }\n      }\n      return false;\n    } catch (error: any) {\n      diag.info(`Failed cleanup of persistent file storage expired files`, error);\n      return false;\n    }\n  }\n}\n\n/**\n * Return the deterministic local storage path for a given instrumentation key.\n *\n * On shared Linux hosts the first user to create `/tmp/Microsoft/AzureMonitor` can\n * block others because the directory inherits that user's `umask`. This is avoided by\n * inserting a hash of the instrumentation key, user name, process name, and\n * application directory, giving each user their own subdirectory, e.g.\n * `/tmp/Microsoft-AzureMonitor-1234...../opentelemetry-nodejs-<ikey>`.\n *\n * @param instrumentationKey - Application Insights instrumentation key.\n * @param storageDirectory - Optional custom storage directory path. If not provided, system temp directory is used.\n * @returns Absolute path to the storage directory.\n * @internal\n */\nexport function getStorageDirectory(\n  instrumentationKey: string,\n  storageDirectory: string | undefined,\n): string {\n  let userSegment: string;\n  let processName: string;\n  let applicationDirectory: string;\n  try {\n    const user = userInfo();\n    userSegment = user.username;\n  } catch (error) {\n    userSegment = \"\";\n  }\n  if (process.title.length > 0) {\n    processName = process.title;\n  } else {\n    processName = \"\";\n  }\n  const applicationDir = dirname(process.cwd() || process.argv[1]);\n  if (applicationDir) {\n    applicationDirectory = applicationDir;\n  } else {\n    applicationDirectory = \"\";\n  }\n  const hash_input = `${instrumentationKey}|${userSegment}|${processName}|${applicationDirectory}`;\n\n  let subDirectory: string;\n  try {\n    subDirectory = createHash(\"sha256\").update(hash_input).digest(\"hex\");\n  } catch (error) {\n    let hash = 5381;\n    for (let i = 0; i < hash_input.length; i++) {\n      const char = hash_input.charCodeAt(i);\n      hash = (hash << 5) + hash + char;\n      hash = hash & hash;\n    }\n    subDirectory = Math.abs(hash).toString(16);\n  }\n\n  let sharedRoot: string;\n  if (storageDirectory) {\n    sharedRoot = storageDirectory;\n  } else {\n    sharedRoot = tmpdir();\n  }\n  return join(\n    sharedRoot,\n    \"Microsoft-AzureMonitor-\" + subDirectory,\n    FileSystemPersist.TEMPDIR_PREFIX + instrumentationKey,\n  );\n}\n"]}