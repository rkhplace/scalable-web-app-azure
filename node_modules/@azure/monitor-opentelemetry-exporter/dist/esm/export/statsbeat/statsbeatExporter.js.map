{"version":3,"file":"statsbeatExporter.js","sourceRoot":"","sources":["../../../../src/export/statsbeat/statsbeatExporter.ts"],"names":[],"mappings":"AAAA,uCAAuC;AACvC,kCAAkC;AAClC,OAAO,EAAE,OAAO,EAAE,MAAM,oBAAoB,CAAC;AAG7C,OAAO,EAAE,gBAAgB,EAAE,eAAe,EAAE,MAAM,qBAAqB,CAAC;AAGxE,OAAO,EAAE,yBAAyB,EAAE,MAAM,4BAA4B,CAAC;AACvE,OAAO,EAAE,wBAAwB,EAAE,MAAM,YAAY,CAAC;AAEtD;;GAEG;AACH,MAAM,OAAO,6BACX,SAAQ,wBAAwB;IAGhC;;OAEG;IACK,WAAW,GAAG,KAAK,CAAC;IACpB,OAAO,CAAM;IACb,cAAc,CAAM;IAE5B;;;OAGG;IACH,YAAY,OAAoC;QAC9C,KAAK,CAAC,OAAO,EAAE,IAAI,CAAC,CAAC;QACrB,4EAA4E;QAC5E,IAAI,CAAC,cAAc,GAAG;YACpB,WAAW,EAAE,IAAI,CAAC,WAAW;YAC7B,kBAAkB,EAAE,IAAI,CAAC,kBAAkB;YAC3C,cAAc,EAAE,IAAI,CAAC,cAAc;YACnC,eAAe,EAAE,OAAO;YACxB,iBAAiB,EAAE,IAAI;SACxB,CAAC;IACJ,CAAC;IAED;;OAEG;IACK,KAAK,CAAC,UAAU;QACtB,IAAI,CAAC,IAAI,CAAC,OAAO,EAAE,CAAC;YAClB,MAAM,EAAE,UAAU,EAAE,GAAG,MAAM,MAAM,CAAC,qCAAqC,CAAC,CAAC;YAC3E,IAAI,CAAC,OAAO,GAAG,IAAI,UAAU,CAAC,IAAI,CAAC,cAAc,CAAC,CAAC;QACrD,CAAC;QACD,OAAO,IAAI,CAAC,OAAO,CAAC;IACtB,CAAC;IAED;;;;;OAKG;IACK,sBAAsB,CAAC,SAAqB;QAClD,OAAO,SAAS,CAAC,MAAM,CAAC,CAAC,QAAQ,EAAE,EAAE;YACnC,qCAAqC;YACrC,IAAI,QAAQ,CAAC,IAAI,EAAE,QAAQ,KAAK,YAAY,IAAI,QAAQ,CAAC,IAAI,EAAE,QAAQ,EAAE,OAAO,EAAE,CAAC;gBACjF,MAAM,OAAO,GAAG,QAAQ,CAAC,IAAI,CAAC,QAAQ,CAAC,OAAO,CAAC;gBAC/C,+CAA+C;gBAC/C,OAAO,OAAO,CAAC,IAAI,CAAC,CAAC,MAAW,EAAE,EAAE,CAAC,MAAM,CAAC,KAAK,KAAK,CAAC,CAAC,CAAC;YAC3D,CAAC;YACD,OAAO,IAAI,CAAC;QACd,CAAC,CAAC,CAAC;IACL,CAAC;IAED;;OAEG;IACH,KAAK,CAAC,MAAM,CACV,OAAwB,EACxB,cAA8C;QAE9C,IAAI,IAAI,CAAC,WAAW,EAAE,CAAC;YACrB,UAAU,CAAC,GAAG,EAAE,CAAC,cAAc,CAAC,EAAE,IAAI,EAAE,gBAAgB,CAAC,MAAM,EAAE,CAAC,EAAE,CAAC,CAAC,CAAC;YACvE,OAAO;QACT,CAAC;QAED,MAAM,SAAS,GAAe,yBAAyB,CACrD,OAAO,EACP,IAAI,CAAC,kBAAkB,EACvB,IAAI,CACL,CAAC;QAEF,8CAA8C;QAC9C,MAAM,iBAAiB,GAAG,IAAI,CAAC,sBAAsB,CAAC,SAAS,CAAC,CAAC;QAEjE,6DAA6D;QAC7D,OAAO,CAAC,IAAI,CAAC,eAAe,CAAC,OAAO,CAAC,MAAM,EAAE,CAAC,EAAE,KAAK,IAAI,EAAE;YACzD,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC,UAAU,EAAE,CAAC;YACvC,cAAc,CAAC,MAAM,MAAM,CAAC,eAAe,CAAC,iBAAiB,CAAC,CAAC,CAAC;QAClE,CAAC,CAAC,CAAC;IACL,CAAC;IAED;;OAEG;IACI,KAAK,CAAC,QAAQ;QACnB,IAAI,CAAC,WAAW,GAAG,IAAI,CAAC;QACxB,IAAI,IAAI,CAAC,OAAO,EAAE,CAAC;YACjB,OAAO,IAAI,CAAC,OAAO,CAAC,QAAQ,EAAE,CAAC;QACjC,CAAC;IACH,CAAC;IAED;;OAEG;IACI,KAAK,CAAC,UAAU;QACrB,OAAO,OAAO,CAAC,OAAO,EAAE,CAAC;IAC3B,CAAC;CACF","sourcesContent":["// Copyright (c) Microsoft Corporation.\n// Licensed under the MIT License.\nimport { context } from \"@opentelemetry/api\";\nimport type { PushMetricExporter, ResourceMetrics } from \"@opentelemetry/sdk-metrics\";\nimport type { ExportResult } from \"@opentelemetry/core\";\nimport { ExportResultCode, suppressTracing } from \"@opentelemetry/core\";\nimport type { AzureMonitorExporterOptions } from \"../../config.js\";\nimport type { TelemetryItem as Envelope } from \"../../generated/index.js\";\nimport { resourceMetricsToEnvelope } from \"../../utils/metricUtils.js\";\nimport { AzureMonitorBaseExporter } from \"../base.js\";\n\n/**\n * Azure Monitor Statsbeat Exporter\n */\nexport class AzureMonitorStatsbeatExporter\n  extends AzureMonitorBaseExporter\n  implements PushMetricExporter\n{\n  /**\n   * Flag to determine if the Exporter is shutdown.\n   */\n  private _isShutdown = false;\n  private _sender: any;\n  private _senderOptions: any;\n\n  /**\n   * Initializes a new instance of the AzureMonitorStatsbeatExporter class.\n   * @param options - Exporter configuration\n   */\n  constructor(options: AzureMonitorExporterOptions) {\n    super(options, true);\n    // Store sender options for lazy initialization to avoid circular dependency\n    this._senderOptions = {\n      endpointUrl: this.endpointUrl,\n      instrumentationKey: this.instrumentationKey,\n      trackStatsbeat: this.trackStatsbeat,\n      exporterOptions: options,\n      isStatsbeatSender: true,\n    };\n  }\n\n  /**\n   * Lazily initialize the sender to avoid circular dependency\n   */\n  private async _getSender(): Promise<any> {\n    if (!this._sender) {\n      const { HttpSender } = await import(\"../../platform/nodejs/httpSender.js\");\n      this._sender = new HttpSender(this._senderOptions);\n    }\n    return this._sender;\n  }\n\n  /**\n   * Filter out envelopes with zero metric values to prevent exporting zero counts.\n   * This ensures zero counts are observed for internal cleanup but not exported to Azure Monitor.\n   * @param envelopes - Array of telemetry envelopes to filter\n   * @returns Filtered array of envelopes with non-zero metric values\n   */\n  private filterZeroValueMetrics(envelopes: Envelope[]): Envelope[] {\n    return envelopes.filter((envelope) => {\n      // Check if this is a metric envelope\n      if (envelope.data?.baseType === \"MetricData\" && envelope.data?.baseData?.metrics) {\n        const metrics = envelope.data.baseData.metrics;\n        // Filter out metrics where all values are zero\n        return metrics.some((metric: any) => metric.value !== 0);\n      }\n      return true;\n    });\n  }\n\n  /**\n   * Export Statsbeat metrics.\n   */\n  async export(\n    metrics: ResourceMetrics,\n    resultCallback: (result: ExportResult) => void,\n  ): Promise<void> {\n    if (this._isShutdown) {\n      setTimeout(() => resultCallback({ code: ExportResultCode.FAILED }), 0);\n      return;\n    }\n\n    const envelopes: Envelope[] = resourceMetricsToEnvelope(\n      metrics,\n      this.instrumentationKey,\n      true, // isStatsbeat flag passed to create a Statsbeat envelope.\n    );\n\n    // Filter out zero-value metrics before export\n    const filteredEnvelopes = this.filterZeroValueMetrics(envelopes);\n\n    // Supress tracing until OpenTelemetry Metrics SDK support it\n    context.with(suppressTracing(context.active()), async () => {\n      const sender = await this._getSender();\n      resultCallback(await sender.exportEnvelopes(filteredEnvelopes));\n    });\n  }\n\n  /**\n   * Shutdown AzureMonitorStatsbeatExporter.\n   */\n  public async shutdown(): Promise<void> {\n    this._isShutdown = true;\n    if (this._sender) {\n      return this._sender.shutdown();\n    }\n  }\n\n  /**\n   * Force flush.\n   */\n  public async forceFlush(): Promise<void> {\n    return Promise.resolve();\n  }\n}\n"]}